var partlength = 0;
var id = '';

function action_sub(name,descr) {
    $('#model_box').modal({backdrop: 'static', keyboard: false});

    $('#action').val(name);
    document.getElementById('action_Modal_title').innerText = descr ;

    var selectnum = document.getElementById('select_num');
    var selectnumall = document.getElementById('select_num_all');

    var model_info = document.getElementById('model_info');


    if (selectnum.style.display == 'none' && selectnumall.style.display != 'none'){
        model_info.innerText = selectnumall.innerText;
    }else {
        model_info.innerText = selectnum.innerText;
    }
}

function getCookieqq(name) {
    var cookieValue = null;
      if (document.cookie && document.cookie != '') {
          var cookies = document.cookie.split(';');
          for (var i = 0; i < cookies.length; i++) {
              var cookie = jQuery.trim(cookies[i]);
              // Does this cookie string begin with the name we want?
              if (cookie.substring(0, name.length + 1) == (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
}

function start_ajax() {
    var model_info = document.getElementById('model_info');
    model_info.innerHTML = model_info.innerHTML + '<span id="zt">正在进行操作，请稍等。。。</span>';
    var model_text = document.getElementById('model_text');
    model_text.innerHTML = '';
    var csrftoken = getCookieqq('csrftoken');
    $.ajax({
        url: "",
        data: $("#changelist-form").serialize(),
        type: "POST",
        dataType: "json",
        beforeSend: function(xhr, settings) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        },
        success: function (result) {
            if (result.rcode == '1'){
                document.getElementById('progress_bar').style.display = '';
                // alert(result.KEY);
                refresh_process(result.KEY);
            }else {
                alert(result.messages);
            }
        },
        error:function (XMLHttpRequest, textStatus, errorThrown) {
            alert('错误信息：' + XMLHttpRequest.responseText); //获取的信息即是异常中的Message
            console.log('错误信息：' + XMLHttpRequest.responseText); //获取的信息即是异常中的Message
            clearInterval(id);
            $('#brPress_id').val('0');
        }
    });
}

function to_submit_action() {
    $('#brPress_id').val('1');
    $('#action_model').addClass('disabled');
    var model_info = document.getElementById('model_info');
    var args=model_info.innerText.match(/\d+/g);
    if (args[args.length-1] >= 100) {
        var r=confirm("当前操作数:"+args[args.length-1]+"超过100,是否继续？");
        if (r==true)
        {
            start_ajax()
        }
        else
        {
            return false
        }
    }else{
        start_ajax()
    }
}


function refresh_process(key) {
    $.getJSON('/wish_store_management/get_refresh_process/?key='+key, function(result){
        if (result.resultCode == '1'||result.resultCode == '2') { //进程查询成功
            var aNum = Number(result.aNum);
            var rNum = Number(result.rNum);
            var eNum = Number(result.eNum);
            var StartTime = result.StartTime;

            var model_text = document.getElementById('model_text');
            model_text.innerHTML ='</br><span id="starttime">' + '开始时间:' + StartTime + '</span><span id="EndTime"></span>' +
                                  '</br><span id="processid">' + '全部:'+aNum + '</br>已成功:'+rNum + '</br>已失败' + eNum + '</span>' +
                                  '</br><div id="elogs"><span>错误日志：</br></span></div>';

            document.getElementById('model_progress').style.width = (((rNum+eNum)/aNum).toFixed(2)).toString() + '%';
            id = setInterval('get_process("'+ key + '")',500);

        }
        if (result.resultCode == '-1'){
            alert(result.errorText);
            console.log(result.errorText);
        }
    });
}


// 更新刷新进度
function get_process(key) {
    $.getJSON('/wish_store_management/get_refresh_process/?key='+key, function(result){
        partlength ++;
        console.log(key);
        console.log(result);
        var process = document.getElementById('processid');
        if ((result.resultCode == '1') || (result.etype == 'download_by_id' && !result.downinfo)) {
            var aNum = Number(result.aNum);
            var rNum = Number(result.rNum);
            var eNum = Number(result.eNum);
            var eLogs = eval(result.eSynLog);

            process.innerHTML = '全部:'+aNum + '</br>已成功:'+rNum + '</br>已失败' + eNum;

            var elogshtml = document.getElementById('elogs');
            var html = '错误日志：<br>';
            for (var i=0;i<eLogs.length;i++){
                html += '<span>'+ eLogs[i]["key"] + ':'+ eLogs[i]["mag"].toString() +'</span><br>';
            }
            elogshtml.innerHTML = html;

            document.getElementById('model_progress').style.width = (((rNum+eNum)/aNum).toFixed(2)*100).toString() + '%';
        }
        else if (result.resultCode == '2'){
            var aNume = Number(result.aNum);
            var rNume = Number(result.rNum);
            var eNume = Number(result.eNum);
            var eeLogs = eval(result.eSynLog);
            var EndTime = result.EndTime;

            var downtext = '';
            if (result.etype == 'download_by_id'){
                downtext = "下载链接:<a href='"+ result.downinfo +"'>点击下载</a></br>"
            }

            process.innerHTML = downtext + '全部:'+aNume + '</br>已成功:'+rNume + '</br>已失败' + eNume;

            var eelogshtml = document.getElementById('elogs');
            var ehtml = '错误日志：<br>';
            for (var e=0; e<eeLogs.length;e++){
                 ehtml += '<span>'+ eeLogs[e]["key"] + ':'+ eeLogs[e]["mag"].toString() +'</span><br>';
            }
            eelogshtml.innerHTML = ehtml;

            var endtime = document.getElementById('EndTime');
            endtime.innerText = '结束时间:'+EndTime;
            document.getElementById('model_progress').style.width = '100%';

            var zt = document.getElementById('zt');
            zt.innerText = '---完成';
            clearInterval(id);
            $('#brPress_id').val('0');
        }
        else if (result.resultCode == '-1'){
            alert(result.errorText);
            console.log(result.errorText);
        }
    });
}


$(function () {
    $('#model_box').on('hide.bs.modal', function () {
        // alert('嘿，我听说您喜欢模态框...');
        var brP = document.getElementById('brPress_id');
        if (brP.value == '1'){
            alert("操作没有完成不能关闭");
            return false
        }
        document.getElementById('model_progress').style.width = '0%';
        document.getElementById('progress_bar').style.display = 'none';
        var model_info = document.getElementById('model_info');
        model_info.innerText = '请在这里输入提示的话';
        var model_text = document.getElementById('model_text');
        model_text.innerText = '日志';
        clearInterval(id);
        location.reload();
    })
});




